<div class="vorspann">Die Idee zu diesem Beitrag ist schnell erklärt. Ich möchte Templates und insbesondere den Prozess der Template-Instanziierung visualisieren. Dank <a title="Link auf https://cppinsights.io/" alt="%7B%22alias%22%3A%22%22%2C%22custom%22%3A%7B%7D%2C%22destination%22%3A%22https%3A%2F%2Fcppinsights.io%2F%22%2C%22version%22%3A1%2C%22user_params%22%3A%22%22%2C%22text%22%3A%22C%2B%2B%20Insights%22%2C%22type%22%3A%22E%22%2C%22target%22%3A%22_blank%22%2C%22anchor%22%3A%22%22%2C%22mediasync_id%22%3A%22%22%2C%22subject%22%3A%22%22%2C%22href%22%3A%22https%3A%2F%2Fcppinsights.io%2F%22%2C%22ir_link%22%3A1%7D" href="https://cppinsights.io/" class="">C++ Insights</a> ist diese Visualisierung einfach möglich.<br></div>
<div class="text"><img class="rteInlinetag" src="https://heise-cms.de/thumbs//3/0/9/8/6/3/3/TN_210319858_1e49504a52.png" title="<ir_inline itemname=bilder_mvp_bild_var2:6 type=2>" style="max-height: 25px; max-width: 25px;"><br></div>
<div class="text">Templates (Klassen-Templates oder Funktions-Templates) sind Familien von Klassen oder Funktionen. Wer ein Template instanziiert, erzeugst du eine konkrete Klasse oder eine konkrete Funktion aus dieser Familie von Klassen oder Funktionen. Hier sind die ersten einfachen Fragen, die ich beantworten möchte. Der Einfachheit halber nenne ich ein Klassen-Template häufig eine generische Klasse und ein Funktions-Template eine generische Funktion.</div>
<div class="ztitel">Wann sollte ein Template implementiert werden? <br></div>
<div class="text">Ein Template sollte dann verwendet werden, wenn eine Funktion oder Klasse für eine generische Idee steht. Eine generische Idee ist nicht an einen konkreten Typ gebunden. Zum Beispiel lässt sich eine Funktion wie <span class="tx_code">max</span> oder ein Container wie <span class="tx_code">vector</span> für viele Datentypen verwenden.<br></div>
<div class="ztitel">Wie lässt sich ein Template definieren? </div>
<div class="text">Als Startpunkt nehme ich eine Funktion <span class="tx_code">max</span> an, die zwei ints annimmt.<br></div>
<div class="pre">int max(int lhs, int rhs) { <br>&nbsp;&nbsp;&nbsp; return (lhs &gt; rhs)? lhs : rhs; <br>}</div>
<div class="text">Eine Funktion in ein Template zu erweitern, ist im Allgemeinen einfach.<br> </div>
<div class="text"><ol><li>Setze die Zeile <span class="tx_code">template &lt;Typname T</span>&gt; vor die Funktion.</li><li>Ersetze den konkreten Typ <span class="tx_code">int</span> durch den Typ-Parameter <span class="tx_code">T</span>.</li></ol></div>
<div class="pre">template &lt;typename T&gt; // (1) <br>T max(T lhs, T rhs) { // (2) <br>&nbsp;&nbsp;&nbsp; return (lhs &gt; rhs)? lhs : rhs; <br>}</div>
<div class="text">Ich muss noch zwei Bemerkungen loswerden. </div>
<div><ol><li>Statt des Namens <span class="tx_code">typename</span> lässt sich auch <span class="tx_code">class</span> verwenden. Ich schlage dringend <span class="tx_code">typename</span> vor, weil <span class="tx_code">T</span> keine Klasse sein muss, sondern ein Typ, ein Nicht-Typ oder ein Template sein kann. </li><li>Wir verwenden aus Konvention<span class="tx_code"> T</span> als Namen für den ersten Typ-Parameter.</li></ol></div>
<div class="text">Das gleiche Vorgehen funktioniert auch zum Umwandeln einer Klasse in ein Klassen-Template. Jetzt komme ich genau zu dem Punkt, an dem mir C++ Insights wertvolle Dienste leistet.<br></div>
<div class="ztitel">Was passiert, wenn das Template instanziiert wird? <br></div>
<div class="text">Im folgenden Beispiel instanziiere ich das Funktions-Template <span class="tx_code">max</span> für <span class="tx_code">int</span> und <span class="tx_code">double</span>.<br></div>
<div class="pre">template &lt;typename T&gt;<br>T max(T lhs, T rhs) { <br>&nbsp;&nbsp;&nbsp; return (lhs &gt; rhs)? lhs : rhs; <br>} <br><br>int main() { <br>&nbsp;&nbsp;&nbsp; max(10, 5); <br>&nbsp;&nbsp; &nbsp;max(10.5, 5.5); <br>}</div>
<div class="text"><a title="Link auf https://cppinsights.io/lnk?code=dGVtcGxhdGUgPHR5cGVuYW1lIFQ+ClQgbWF4KFQgbGhzLCBUIHJocykgewogICAgcmV0dXJuIChsaHMgPiByaHMpPyBsaHMgOiByaHM7Cn0KCmludCBtYWluKCkgewogIAogICAgbWF4KDEwLCA1KTsKICAgIG1heCgxMC41LCA1LjUpOwogIAp9&amp;insightsOptions=cpp2a&amp;std=cpp2a&amp;rev=1.0" alt="%7B%22ir_link%22%3A1%2C%22subject%22%3A%22%22%2C%22mediasync_id%22%3A%22%22%2C%22href%22%3A%22https%3A%2F%2Fcppinsights.io%2Flnk%3Fcode%3DdGVtcGxhdGUgPHR5cGVuYW1lIFQ%2BClQgbWF4KFQgbGhzLCBUIHJocykgewogICAgcmV0dXJuIChsaHMgPiByaHMpPyBsaHMgOiByaHM7Cn0KCmludCBtYWluKCkgewogIAogICAgbWF4KDEwLCA1KTsKICAgIG1heCgxMC41LCA1LjUpOwogIAp9%26amp%3BinsightsOptions%3Dcpp2a%26amp%3Bstd%3Dcpp2a%26amp%3Brev%3D1.0%22%2C%22anchor%22%3A%22%22%2C%22target%22%3A%22_blank%22%2C%22text%22%3A%22C%2B%2B%20Insights%22%2C%22type%22%3A%22E%22%2C%22destination%22%3A%22https%3A%2F%2Fcppinsights.io%2Flnk%3Fcode%3DdGVtcGxhdGUgPHR5cGVuYW1lIFQ%2BClQgbWF4KFQgbGhzLCBUIHJocykgewogICAgcmV0dXJuIChsaHMgPiByaHMpPyBsaHMgOiByaHM7Cn0KCmludCBtYWluKCkgewogIAogICAgbWF4KDEwLCA1KTsKICAgIG1heCgxMC41LCA1LjUpOwogIAp9%26amp%3BinsightsOptions%3Dcpp2a%26amp%3Bstd%3Dcpp2a%26amp%3Brev%3D1.0%22%2C%22user_params%22%3A%22%22%2C%22version%22%3A1%2C%22alias%22%3A%22%22%2C%22custom%22%3A%7B%7D%7D" href="https://cppinsights.io/lnk?code=dGVtcGxhdGUgPHR5cGVuYW1lIFQ+ClQgbWF4KFQgbGhzLCBUIHJocykgewogICAgcmV0dXJuIChsaHMgPiByaHMpPyBsaHMgOiByaHM7Cn0KCmludCBtYWluKCkgewogIAogICAgbWF4KDEwLCA1KTsKICAgIG1heCgxMC41LCA1LjUpOwogIAp9&amp;insightsOptions=cpp2a&amp;std=cpp2a&amp;rev=1.0" class="">C++ Insights</a> gibt tiefe Einsicht in den automatischen Prozess der Template Instanziierung.<br></div>
<div class="pre"><img class="rteInlinetag" src="https://heise-cms.de/thumbs//3/0/9/8/6/3/3/TN_210319838_0c594706bf.png" title="<ir_inline itemname=bilder_mvp_bild_var2:2 type=2>" style="max-height: 25px; max-width: 25px;"></div>
<div class="text">Der Prozess der Template-Instanziierung erzeugt die Zeilen 6 bis 23. Lass mich ein paar Worte über die Instanziierung der Funktion <span class="tx_code">max</span> für die beiden ints schreiben (Zeilen 6 bis 13). Zeile 6 im Screenshot drückt aus, dass Zeile 8 in der Quelldatei (<span class="tx_code">max(10, 5)</span>) die Erzeugung der Zeilen 6 bis 13 verursacht. Ich nehme an, dass die ersten beiden Zeilen des vom Compiler generierten Codes die interessantesten sind.<br></div>
<div class="pre">template&lt;&gt; <br>int max&lt;int&gt;(int lhs, int rhs) { <br>&nbsp;&nbsp;&nbsp; return (lhs &gt; rhs) ? lhs : rhs; <br>}</div>
<div class="text"><span class="tx_code">max</span> ist ein vollständig spezialisiertes Funktions-Template für <span class="tx_code">int: max&lt;int</span>&gt;.&nbsp; Der generische Teil ist leer: <span class="tx_code">template&lt;&gt;</span>. Der Compiler erzeugt aus der Familie der <span class="tx_code">max</span>-Funktionen eine konkrete Funktion für <span class="tx_code">int</span>. Heißt das auch, dass der Compiler für jeden verwendeten Typ eine konkrete Funktion generiert?<br></div>
<div class="ztitel">Was passiert, wenn ein Template mehrmals für den gleichen Typ instanziiert wird? <br></div>
<div class="text">Mein nächstes Beispiel basiert auf einem Klassen-Template. Dieses Template ist ein einfacher Container, der mehrmals für <span class="tx_code">int</span> instanziiert wird. <br></div>
<div class="pre">template &lt;typename T, int N&gt;<br>class Array{<br>&nbsp;public:<br>&nbsp;&nbsp;&nbsp; int getSize() const{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return N;<br>&nbsp;&nbsp;&nbsp; }<br>&nbsp;private:<br>&nbsp;&nbsp;&nbsp; T elem[N];<br>};<br><br>int main() {<br>&nbsp; <br>&nbsp;&nbsp;&nbsp; Array&lt;int, 5&gt; myArr1;&nbsp; // (1)<br>&nbsp;&nbsp;&nbsp; Array&lt;int, 10&gt; myArr2; // (2)<br>&nbsp;&nbsp;&nbsp; Array&lt;int, 5&gt; myArr3;&nbsp; // (3)<br>&nbsp; <br>}</div>
<div class="text">Ich habe zweimal<span class="tx_code"> Array&lt;int, 5&gt;</span> (1) und (3) und einmal <span class="tx_code">Array&lt;int, 10&gt; </span>(2) instanziiert. Die Ausgabe von <a title="Link auf https://cppinsights.io/lnk?code=dGVtcGxhdGUgPHR5cGVuYW1lIFQsIGludCBOPgpjbGFzcyBBcnJheXsKIHB1YmxpYzoKICAgIGludCBnZXRTaXplKCkgY29uc3R7CiAgICAgICAgcmV0dXJuIE47CiAgICB9CiBwcml2YXRlOgogICAgVCBlbGVtW05dOwp9OwoKaW50IG1haW4oKSB7CiAgCiAgICBBcnJheTxpbnQsIDU+IG15QXJyMTsKICAgIEFycmF5PGludCwgMTA+IG15QXJyMjsKICAgIEFycmF5PGludCwgNT4gbXlBcnIzOwogIAp9&amp;insightsOptions=cpp2a&amp;std=cpp2a&amp;rev=1.0" alt="%7B%22href%22%3A%22https%3A%2F%2Fcppinsights.io%2Flnk%3Fcode%3DdGVtcGxhdGUgPHR5cGVuYW1lIFQsIGludCBOPgpjbGFzcyBBcnJheXsKIHB1YmxpYzoKICAgIGludCBnZXRTaXplKCkgY29uc3R7CiAgICAgICAgcmV0dXJuIE47CiAgICB9CiBwcml2YXRlOgogICAgVCBlbGVtW05dOwp9OwoKaW50IG1haW4oKSB7CiAgCiAgICBBcnJheTxpbnQsIDU%2BIG15QXJyMTsKICAgIEFycmF5PGludCwgMTA%2BIG15QXJyMjsKICAgIEFycmF5PGludCwgNT4gbXlBcnIzOwogIAp9%26amp%3BinsightsOptions%3Dcpp2a%26amp%3Bstd%3Dcpp2a%26amp%3Brev%3D1.0%22%2C%22subject%22%3A%22%22%2C%22mediasync_id%22%3A%22%22%2C%22ir_link%22%3A1%2C%22custom%22%3A%7B%7D%2C%22alias%22%3A%22%22%2C%22user_params%22%3A%22%22%2C%22version%22%3A1%2C%22destination%22%3A%22https%3A%2F%2Fcppinsights.io%2Flnk%3Fcode%3DdGVtcGxhdGUgPHR5cGVuYW1lIFQsIGludCBOPgpjbGFzcyBBcnJheXsKIHB1YmxpYzoKICAgIGludCBnZXRTaXplKCkgY29uc3R7CiAgICAgICAgcmV0dXJuIE47CiAgICB9CiBwcml2YXRlOgogICAgVCBlbGVtW05dOwp9OwoKaW50IG1haW4oKSB7CiAgCiAgICBBcnJheTxpbnQsIDU%2BIG15QXJyMTsKICAgIEFycmF5PGludCwgMTA%2BIG15QXJyMjsKICAgIEFycmF5PGludCwgNT4gbXlBcnIzOwogIAp9%26amp%3BinsightsOptions%3Dcpp2a%26amp%3Bstd%3Dcpp2a%26amp%3Brev%3D1.0%22%2C%22target%22%3A%22_blank%22%2C%22text%22%3A%22C%2B%2B%20Insights%22%2C%22type%22%3A%22E%22%2C%22anchor%22%3A%22%22%7D" href="https://cppinsights.io/lnk?code=dGVtcGxhdGUgPHR5cGVuYW1lIFQsIGludCBOPgpjbGFzcyBBcnJheXsKIHB1YmxpYzoKICAgIGludCBnZXRTaXplKCkgY29uc3R7CiAgICAgICAgcmV0dXJuIE47CiAgICB9CiBwcml2YXRlOgogICAgVCBlbGVtW05dOwp9OwoKaW50IG1haW4oKSB7CiAgCiAgICBBcnJheTxpbnQsIDU+IG15QXJyMTsKICAgIEFycmF5PGludCwgMTA+IG15QXJyMjsKICAgIEFycmF5PGludCwgNT4gbXlBcnIzOwogIAp9&amp;insightsOptions=cpp2a&amp;std=cpp2a&amp;rev=1.0" class="">C++ Insights</a> zeigt, dass die zweite Instanziierung von <span class="tx_code">Array&lt;int, 5&gt;</span> (3) die erste Instanziierung, die bereits durch (1) angestoßen wurde, verwendet. Hier sind die relevanten Teile der Ausgabe.<br></div>
<div class="pre"><img class="rteInlinetag" src="https://heise-cms.de/thumbs//3/0/9/8/6/3/3/TN_210319840_868b0b5a26.png" title="<ir_inline itemname=bilder_mvp_bild_var2:3 type=2>" style="max-height: 25px; max-width: 25px;"><br></div>
<div class="text">Sind wir fertig mit diesem Beispiel? Nein! Es gibt zwei weitere interessante Beobachtungen, auf die ich eingehen möchte: Erstens, der Prozess der Template-Instanziierung ist lazy. Zweitens, ich verwendete einen Nicht-Typ Template-Parameter.<br></div>
<div class="ztitel">Template Instanziierung ist lazy</div>
<div class="text">Die Memberfunktion<span class="tx_code"> getSize() </span>wurde nicht instanziiert? Nur die Deklaration der Member-Funktion ist vorhanden. Der Prozess der Template-Instanziierung ist lazy. Das heißt, wenn die Member-Funktion nicht aufgerufen wird, wird sie auch nicht instanziiert. Das geht so weit, dass ungültiger Code in einer Member-Funktion verwendet werden kann. Natürlich darf diese dann nicht aufgerufen werden. Wenn du mir nicht glaubst, dann kompiliere das folgende kleine Programm. Deaktiviere zunächst (1) und aktiviere es dann.</div>
<div class="pre">// number.cpp<br><br>#include &lt;cmath&gt;<br>#include &lt;string&gt;<br><br>template &lt;typename T&gt;<br>struct Number {<br>&nbsp;&nbsp; &nbsp;int absValue() {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return std::abs(val);<br>&nbsp;&nbsp;&nbsp; }<br>&nbsp; T val{};<br>};<br><br>int main() {<br>&nbsp; <br>&nbsp;&nbsp;&nbsp; Number&lt;std::string&gt; numb;<br>&nbsp;&nbsp;&nbsp; // numb.absValue();&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // (1)<br>&nbsp; <br>}</div>
<div class="text">Gehen wir zurück zu meinem vorherigen Programm und rufen <span class="tx_code">getSize()</span> auf. Hier ist das modifizierte <span class="tx_code">main</span>-Programm.</div>
<div class="pre">int main() {<br>&nbsp; <br>&nbsp;&nbsp;&nbsp; Array&lt;int, 5&gt; myArr1; &nbsp;<br>&nbsp;&nbsp;&nbsp; Array&lt;int, 10&gt; myArr2; <br>&nbsp;&nbsp;&nbsp; Array&lt;int, 5&gt; myArr3; &nbsp;<br>&nbsp;&nbsp;&nbsp; myArr3.getSize();&nbsp;&nbsp;&nbsp;&nbsp; // (1)<br>&nbsp; <br>}</div>
<div class="text">Dementsprechend zeigt der folgende Screenshot den vom Compiler generierten Code für die Memberfunktion <span class="tx_code">getSize()</span> (Zeilen 18 - 21).<br></div>
<div class="text"><img class="rteInlinetag" src="https://heise-cms.de/thumbs//3/0/9/8/6/3/3/TN_210319846_3b29f52c43.png" title="<ir_inline itemname=bilder_mvp_bild_var2:4 type=2>" style="max-height: 25px; max-width: 25px;"><br></div>
<div class="ztitel_kleiner"><span class="tx_code">int</span> ist ein Nicht-Typ Template-Parameter</div>
<div class="text">Ich habe in diesem Beispiel zwei Template-Parameter verwendet, wobei der zweite insbesondere ein <span class="tx_code">int</span> ist. <span class="tx_code">int</span> ist ein Beispiel für einen Nicht-Typ Template-Parameter. Neben <span class="tx_code">int</span> können alle ganzzahligen Typen, Fließkommatypen (C++20), aber auch Zeiger, oder Referenzen als Nicht-Typ Template-Parameter verwendet werden. Was passiert, wenn ich zwei Arrays mit unterschiedlicher Länge instanziiere?</div>
<div class="pre">template &lt;typename T, int N&gt;<br>class Array{<br>&nbsp;public:<br>&nbsp;&nbsp;&nbsp; int getSize() const{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return N;<br>&nbsp;&nbsp;&nbsp; }<br>&nbsp;private:<br>&nbsp;&nbsp;&nbsp; T elem[N];<br>};<br><br>int main() {<br>&nbsp; <br>&nbsp;&nbsp;&nbsp; Array&lt;float, 5&gt; myArr1;<br>&nbsp;&nbsp;&nbsp; Array&lt;float, 10&gt; myArr2;<br>&nbsp; <br>}</div>
<div class="text">Die meisten habe es vermutlich erraten: Zwei Arrays werden instanziiert. Hier ist die entscheidende Ausgabe von<a title="Link auf https://cppinsights.io/lnk?code=dGVtcGxhdGUgPHR5cGVuYW1lIFQsIGludCBOPgpjbGFzcyBBcnJheXsKIHB1YmxpYzoKICAgIGludCBnZXRTaXplKCkgY29uc3R7CiAgICAgICAgcmV0dXJuIE47CiAgICB9CiBwcml2YXRlOgogICAgVCBlbGVtW05dOwp9OwoKaW50IG1haW4oKSB7CiAgCiAgICBBcnJheTxmbG9hdCwgNT4gbXlBcnIxOwogICAgQXJyYXk8ZmxvYXQsIDEwPiBteUFycjI7CiAgCn0=&amp;insightsOptions=cpp2a&amp;std=cpp2a&amp;rev=1.0" alt="%7B%22alias%22%3A%22%22%2C%22custom%22%3A%7B%7D%2C%22destination%22%3A%22https%3A%2F%2Fcppinsights.io%2Flnk%3Fcode%3DdGVtcGxhdGUgPHR5cGVuYW1lIFQsIGludCBOPgpjbGFzcyBBcnJheXsKIHB1YmxpYzoKICAgIGludCBnZXRTaXplKCkgY29uc3R7CiAgICAgICAgcmV0dXJuIE47CiAgICB9CiBwcml2YXRlOgogICAgVCBlbGVtW05dOwp9OwoKaW50IG1haW4oKSB7CiAgCiAgICBBcnJheTxmbG9hdCwgNT4gbXlBcnIxOwogICAgQXJyYXk8ZmxvYXQsIDEwPiBteUFycjI7CiAgCn0%3D%26amp%3BinsightsOptions%3Dcpp2a%26amp%3Bstd%3Dcpp2a%26amp%3Brev%3D1.0%22%2C%22version%22%3A1%2C%22user_params%22%3A%22%22%2C%22target%22%3A%22_blank%22%2C%22text%22%3A%22%20C%2B%2B%20Insights%22%2C%22type%22%3A%22E%22%2C%22anchor%22%3A%22%22%2C%22mediasync_id%22%3A%22%22%2C%22subject%22%3A%22%22%2C%22href%22%3A%22https%3A%2F%2Fcppinsights.io%2Flnk%3Fcode%3DdGVtcGxhdGUgPHR5cGVuYW1lIFQsIGludCBOPgpjbGFzcyBBcnJheXsKIHB1YmxpYzoKICAgIGludCBnZXRTaXplKCkgY29uc3R7CiAgICAgICAgcmV0dXJuIE47CiAgICB9CiBwcml2YXRlOgogICAgVCBlbGVtW05dOwp9OwoKaW50IG1haW4oKSB7CiAgCiAgICBBcnJheTxmbG9hdCwgNT4gbXlBcnIxOwogICAgQXJyYXk8ZmxvYXQsIDEwPiBteUFycjI7CiAgCn0%3D%26amp%3BinsightsOptions%3Dcpp2a%26amp%3Bstd%3Dcpp2a%26amp%3Brev%3D1.0%22%2C%22ir_link%22%3A1%7D" href="https://cppinsights.io/lnk?code=dGVtcGxhdGUgPHR5cGVuYW1lIFQsIGludCBOPgpjbGFzcyBBcnJheXsKIHB1YmxpYzoKICAgIGludCBnZXRTaXplKCkgY29uc3R7CiAgICAgICAgcmV0dXJuIE47CiAgICB9CiBwcml2YXRlOgogICAgVCBlbGVtW05dOwp9OwoKaW50IG1haW4oKSB7CiAgCiAgICBBcnJheTxmbG9hdCwgNT4gbXlBcnIxOwogICAgQXJyYXk8ZmxvYXQsIDEwPiBteUFycjI7CiAgCn0=&amp;insightsOptions=cpp2a&amp;std=cpp2a&amp;rev=1.0" class=""> C++ Insights</a>.</div>
<div class="text"><img class="rteInlinetag" src="https://heise-cms.de/thumbs//3/0/9/8/6/3/3/TN_210319851_20ab0a9047.png" title="<ir_inline itemname=bilder_mvp_bild_var2:5 type=2>" style="max-height: 25px; max-width: 25px;"></div>
<div class="text">Das bedeutet, dass beide Instanziierungen mit unterschiedlichen <span class="tx_code">int</span>-Werten unterschiedliche Typen erzeugen.</div>
<div class="ztitel">Wie geht es weiter?</div>
<div class="text">Nach diesen ersten Schritten mit Templates, tauche ich in meinen nächsten Artikel deutlich tiefer in Funktions-Templates ein.<br></div>