<div class="text">Metaprogrammierung ist Programmieren zur Compilezeit. Es begann in C++98 mit der Template-Metaprogrammierung, wurde in C++11 mit der Type-Traits-Bibliothek formalisiert und hat sich seit C++11 stetig verbessert. Die wichtigste treibende Kraft sind konstante Ausdrücke. In diesem Beitrag möchte ich über ihre Ursprünge schreiben.</div><div class="text"><img class="rteInlinetag" src="https://heise-cms.de/thumbs//3/1/9/7/2/7/1/TN_219030939_e01a09b3de.png" title="<ir_inline itemname=bilder_mvp_bild_var2:1 type=2>" style="max-height: 25px; max-width: 25px;"> </div><div class="text">Meine Motivation, über Template-Metaprogrammierung zu schreiben, besteht darin, ihre Techniken zu entmystifizieren, um Dir zu helfen, die Funktionen der Type-Traits-Bibliothek besser zu verstehen und insbesondere <span class="tx_code">constexpr</span> zu schätzen. Der schlechte Ruf der Template-Metaprogrammierung rührt vor allem daher, dass ihre Fehlermeldungen epische Länge besitzen können. Template-Metaprogrammierung wurde nicht entworfen, sie begann mit einem Unfall.</div><div class="utitel">Der Unfall<br></div><div class="text">1994 stellte Erwin Unruh von Siemens auf einer C++-Ausschusssitzung ein Programm vor, das sich nicht compilieren ließ. Dieses wohl berühmteste Programm, das sich nicht compilieren ließ, sah folgendermaßen aus:</div><div class="pre">// Prime number computation by Erwin Unruh<br>template &lt;int i&gt; struct D { D(void*); operator int(); };<br><br>template &lt;int p, int i&gt; struct is_prime {<br>&nbsp;&nbsp;&nbsp; enum { prim = (p%i) &amp;&amp; is_prime&lt;(i &gt; 2 ? p : 0), i -1&gt; :: prim };<br>&nbsp;&nbsp;&nbsp; };<br><br>template &lt; int i &gt; struct Prime_print {<br>&nbsp;&nbsp;&nbsp; Prime_print&lt;i-1&gt; a;<br>&nbsp;&nbsp;&nbsp; enum { prim = is_prime&lt;i, i-1&gt;::prim };<br>&nbsp;&nbsp;&nbsp; void f() { D&lt;i&gt; d = prim; }<br>&nbsp;&nbsp;&nbsp; };<br><br>struct is_prime&lt;0,0&gt; { enum {prim=1}; };<br>struct is_prime&lt;0,1&gt; { enum {prim=1}; };<br>struct Prime_print&lt;2&gt; { enum {prim = 1}; void f() { D&lt;2&gt; d = prim; } };<br>#ifndef LAST<br>#define LAST 10<br>#endif<br>main () {<br>&nbsp;&nbsp;&nbsp; Prime_print&lt;LAST&gt; a;<br>&nbsp;&nbsp;&nbsp; } </div><div class="text">Unruh hat den Metaware Compiler benutzt, aber das Programm ist nicht mehr für C++ gültig. Eine <a title="Link auf http://www.erwin-unruh.de/prim.html" alt="%7B%22target%22%3A%22_blank%22%2C%22version%22%3A1%2C%22anchor%22%3A%22%22%2C%22mediasync_id%22%3A%22%22%2C%22href%22%3A%22http%3A%2F%2Fwww.erwin-unruh.de%2Fprim.html%22%2C%22destination%22%3A%22http%3A%2F%2Fwww.erwin-unruh.de%2Fprim.html%22%2C%22user_params%22%3A%22%22%2C%22custom%22%3A%7B%7D%2C%22ir_link%22%3A1%2C%22type%22%3A%22E%22%2C%22text%22%3A%22neuere%20Variante%22%2C%22subject%22%3A%22%22%2C%22alias%22%3A%22%22%7D" href="http://www.erwin-unruh.de/prim.html">neuere Variante</a> hält der Autor ebenfalls bereit. Okay, warum ist dieses Programm so berühmt? Werfen wir einen Blick auf die ursprünglichen Fehlermeldungen, die <span class="tx_code">type</span> als <span class="tx_code">txpe</span> schrieb.</div><div class="text"><img class="rteInlinetag" src="https://heise-cms.de/thumbs//3/1/9/7/2/7/1/TN_219030941_d40888c180.png" title="<ir_inline itemname=bilder_mvp_bild_var2:3 type=2>" style="max-height: 25px; max-width: 25px;">&nbsp;</div><div class="text">Ich habe die wichtigen Teile in Rot hervorgehoben. Ich denke, du erkennst das Muster. Das Programm berechnet zur Compilezeit die ersten Primzahlen bis 30. Das bedeutet, dass die Instanziierung von Templates verwendet werden kann, um zur Compilezeit Mathematik zu betreiben. Es ist sogar noch besser. Die Template-Metaprogrammierung ist Turing-komplett und kann daher zur Lösung jedes Rechenproblems verwendet werden. Natürlich gilt die Turing-Vollständigkeit für die Template-Metaprogrammierung nur in der Theorie, denn die Instanziierungstiefe der Rekursion (mindestens 1024 bei C++11) und die Länge der Namen, die bei der Template-Instanziierung erzeugt werden, setzen einige Grenzen.</div><div class="ztitel">Wie funktioniert die Magie?</div><div class="text">Lasse mich Schritt für Schritt aufschlüsseln, was vor sich geht.</div><div class="text">Berechnen zur Compilezeit</div><div class="text">Die Berechnung der Fakultät einer Zahl ist das "Hello World" der Template-Metaprogrammierung:</div><div class="pre">// factorial.cpp<br><br>#include &lt;iostream&gt;<br><br>template &lt;int N&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // (2)<br>struct Factorial{<br>&nbsp;&nbsp;&nbsp; static int const value = N * Factorial&lt;N-1&gt;::value;<br>};<br><br>template &lt;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // (3)<br>struct Factorial&lt;1&gt;{<br>&nbsp;&nbsp;&nbsp; static int const value = 1;<br>};<br><br>int main(){<br>&nbsp;&nbsp; &nbsp;<br>&nbsp;&nbsp;&nbsp; std::cout &lt;&lt; '\n';<br>&nbsp;&nbsp; &nbsp;<br>&nbsp;&nbsp;&nbsp; std::cout &lt;&lt; "Factorial&lt;5&gt;::value: " &lt;&lt; Factorial&lt;5&gt;::value &lt;&lt; '\n'; // (1)<br>&nbsp;&nbsp;&nbsp; std::cout &lt;&lt; "Factorial&lt;10&gt;::value: " &lt;&lt; Factorial&lt;10&gt;::value &lt;&lt; '\n';//(4)<br>&nbsp;&nbsp; &nbsp;<br>&nbsp;&nbsp;&nbsp; std::cout &lt;&lt; '\n' ;<br><br>}</div><div class="text">Der Aufruf<span class="tx_code"> factorial&lt;5&gt;::value</span> in Zeile (1) bewirkt die Instanziierung des primären oder allgemeinen Templates in Zeile (2). Während dieser Instanziierung wird <span class="tx_code">Factorial&lt;4&gt;::value</span> erzeugt. Diese Rekursion endet, wenn das vollständig spezialisierte Klassen-Template <span class="tx_code">Factorial&lt;1&gt; </span>in Zeile (3) verwendet wird.&nbsp; Vielleicht magst du es etwas bildhafter.</div><div class="text"><img class="rteInlinetag" src="https://heise-cms.de/thumbs//3/1/9/7/2/7/1/TN_219030951_eed6811eeb.png" title="<ir_inline itemname=bilder_mvp_bild_var2:4 type=2>" style="max-height: 25px; max-width: 25px;"><br></div><div class="text">Hier folgt die Ausgabe des Programms:</div><div class="text"><img class="rteInlinetag" src="https://heise-cms.de/thumbs//3/1/9/7/2/7/1/TN_219030952_03e71e32a7.png" title="<ir_inline itemname=bilder_mvp_bild_var2:5 type=2>" style="max-height: 25px; max-width: 25px;"><br></div><div class="text">Dank der <a title="Link auf https://cppinsights.io/s/ad3d8a2a" alt="%7B%22subject%22%3A%22%22%2C%22alias%22%3A%22%22%2C%22text%22%3A%22C%2B%2B%20Insights%22%2C%22type%22%3A%22E%22%2C%22user_params%22%3A%22%22%2C%22destination%22%3A%22https%3A%2F%2Fcppinsights.io%2Fs%2Fad3d8a2a%22%2C%22href%22%3A%22https%3A%2F%2Fcppinsights.io%2Fs%2Fad3d8a2a%22%2C%22mediasync_id%22%3A%22%22%2C%22anchor%22%3A%22%22%2C%22ir_link%22%3A1%2C%22custom%22%3A%7B%7D%2C%22target%22%3A%22_blank%22%2C%22version%22%3A1%7D" href="https://cppinsights.io/s/ad3d8a2a">C++ Insights</a> und des <a title="Link auf https://godbolt.org/z/5j11zj1ax" alt="%7B%22version%22%3A1%2C%22target%22%3A%22_blank%22%2C%22custom%22%3A%7B%7D%2C%22ir_link%22%3A1%2C%22mediasync_id%22%3A%22%22%2C%22href%22%3A%22https%3A%2F%2Fgodbolt.org%2Fz%2F5j11zj1ax%22%2C%22anchor%22%3A%22%22%2C%22user_params%22%3A%22%22%2C%22destination%22%3A%22https%3A%2F%2Fgodbolt.org%2Fz%2F5j11zj1ax%22%2C%22type%22%3A%22E%22%2C%22text%22%3A%22Compiler%20Explore%22%2C%22subject%22%3A%22%22%2C%22alias%22%3A%22%22%7D" href="https://godbolt.org/z/5j11zj1ax">Compiler Explore</a> kannst und solltest du das Programm weiter analysieren. Das sollte dir helfen, dein Gespür für Template-Instanziierung und Template-Metaprogrammierung zu schärfen.<br> </div><div class="text">Lasse mich mit C++ Insights beginnen:<br> </div><div class="ztitel_kleiner">C++ Insights<br></div><div class="text">Der Aufruf<span class="tx_code"> Factorial&lt;5&gt;::value</span> (Zeile 1) bewirkt die Instanziierung der Klassen-Templates für die Zahlen 5 bis 2. Die vollständige Spezialisierung für 1 ist bereits vorhanden. Der Aufruf<span class="tx_code"> Factorial&lt;10&gt;::value</span> (Zeile 2) bewirkt die Instanziierung der Funktions-Templates für die Zahlen 10 - 6, da alle anderen voll spezialisierten Funktions-Templates bereits verfügbar sind. Die folgende Ausgabe zeigt die Instanziierung für die Zahlen 5 bis 2.</div><div class="text"><img class="rteInlinetag" src="https://heise-cms.de/thumbs//3/1/9/7/2/7/1/TN_219030980_a9b38b252c.png" title="<ir_inline itemname=bilder_mvp_bild_var2:9 type=2>" style="max-height: 25px; max-width: 25px;"><br></div><div class="text">Jetzt geht meine Analyse mit dem Compiler Explorer weiter.</div><div class="ztitel_kleiner">Compiler-Explorer</div><div class="text">Der Einfachheit halber stelle ich nur einen Screenshot des Hauptprogramms und der entsprechenden Assembler-Anweisungen zur Verfügung.</div><div class="text">Der <a title="Link auf https://godbolt.org/z/5j11zj1ax" alt="%7B%22alias%22%3A%22%22%2C%22subject%22%3A%22%22%2C%22text%22%3A%22Compiler%20Explorer%22%2C%22type%22%3A%22E%22%2C%22ir_link%22%3A1%2C%22custom%22%3A%7B%7D%2C%22destination%22%3A%22https%3A%2F%2Fgodbolt.org%2Fz%2F5j11zj1ax%22%2C%22user_params%22%3A%22%22%2C%22anchor%22%3A%22%22%2C%22mediasync_id%22%3A%22%22%2C%22href%22%3A%22https%3A%2F%2Fgodbolt.org%2Fz%2F5j11zj1ax%22%2C%22version%22%3A1%2C%22target%22%3A%22_blank%22%7D" href="https://godbolt.org/z/5j11zj1ax">Compiler Explorer</a> ermöglicht es dir, diese Compilezeitberechnung zu visualisieren.</div><div class="text">&nbsp;<img class="rteInlinetag" src="https://heise-cms.de/thumbs//3/1/9/7/2/7/1/TN_219030969_4977846f1c.png" title="<ir_inline itemname=bilder_mvp_bild_var2:7 type=2>" style="max-height: 25px; max-width: 25px;"><br></div><div class="text"><img class="rteInlinetag" src="https://heise-cms.de/thumbs//3/1/9/7/2/7/1/TN_219030972_cb3c6f3697.png" title="<ir_inline itemname=bilder_mvp_bild_var2:8 type=2>" style="max-height: 25px; max-width: 25px;"><br></div><div class="text">Die Ausgabe zeigt es. Die Fakultäten von 5 und 10 sind nur Konstanten und werden während der Compilezeit berechnet. Du kannst das Ergebnis direkt in der ersten und letzten Zeile der Assembler-Anweisungen sehen.</div><div class="ztitel">CppCon 2021</div><div class="text">Glücklicherweise konnte ich einen früheren Beitrag als Ausgangspunkt für die heutigen Ausführungen zur Template-Metaprogrammierung verwenden. Ich habe diese Woche <a title="Link auf https://cppcon.org/program2021/" alt="%7B%22subject%22%3A%22%22%2C%22alias%22%3A%22%22%2C%22text%22%3A%22vier%20Vortr%C3%A4ge%20auf%20der%20CppCon%22%2C%22type%22%3A%22E%22%2C%22ir_link%22%3A1%2C%22custom%22%3A%7B%7D%2C%22user_params%22%3A%22%22%2C%22destination%22%3A%22https%3A%2F%2Fcppcon.org%2Fprogram2021%2F%22%2C%22href%22%3A%22https%3A%2F%2Fcppcon.org%2Fprogram2021%2F%22%2C%22mediasync_id%22%3A%22%22%2C%22anchor%22%3A%22%22%2C%22version%22%3A1%2C%22target%22%3A%22_blank%22%7D" href="https://cppcon.org/program2021/">vier Vorträge auf der CppCon</a> gehalten und ehrlich gesagt, war das zu viel. Hier sind meine Vorträge, die in ein paar Wochen aus <a title="Link auf https://www.youtube.com/user/CppCon" alt="%7B%22version%22%3A1%2C%22target%22%3A%22_blank%22%2C%22custom%22%3A%7B%7D%2C%22ir_link%22%3A1%2C%22mediasync_id%22%3A%22%22%2C%22href%22%3A%22https%3A%2F%2Fwww.youtube.com%2Fuser%2FCppCon%22%2C%22anchor%22%3A%22%22%2C%22user_params%22%3A%22%22%2C%22destination%22%3A%22https%3A%2F%2Fwww.youtube.com%2Fuser%2FCppCon%22%2C%22type%22%3A%22E%22%2C%22text%22%3A%22CppCons%20Youtube-Kanal%22%2C%22alias%22%3A%22%22%2C%22subject%22%3A%22%22%7D" href="https://www.youtube.com/user/CppCon">CppCons Youtube-Kanal</a> hier veröffentlicht werden.</div><div class="text"><ul><li> <a title="Link auf https://www.grimm-jaud.de/images/stories/pdfs/ConcurrencyPatterns.pdf" alt="%7B%22ir_link%22%3A1%2C%22custom%22%3A%7B%7D%2C%22destination%22%3A%22https%3A%2F%2Fwww.grimm-jaud.de%2Fimages%2Fstories%2Fpdfs%2FConcurrencyPatterns.pdf%22%2C%22user_params%22%3A%22%22%2C%22anchor%22%3A%22%22%2C%22href%22%3A%22https%3A%2F%2Fwww.grimm-jaud.de%2Fimages%2Fstories%2Fpdfs%2FConcurrencyPatterns.pdf%22%2C%22mediasync_id%22%3A%22%22%2C%22version%22%3A1%2C%22target%22%3A%22_blank%22%2C%22subject%22%3A%22%22%2C%22alias%22%3A%22%22%2C%22text%22%3A%22Concurrency%20Patterns%22%2C%22type%22%3A%22E%22%7D" href="https://www.grimm-jaud.de/images/stories/pdfs/ConcurrencyPatterns.pdf">Concurrency Patterns</a> </li><li> <a title="Link auf https://www.grimm-jaud.de/images/stories/pdfs/TheManyFlavorsOfConstnessInModernCpp.pdf" alt="%7B%22target%22%3A%22_blank%22%2C%22version%22%3A1%2C%22destination%22%3A%22https%3A%2F%2Fwww.grimm-jaud.de%2Fimages%2Fstories%2Fpdfs%2FTheManyFlavorsOfConstnessInModernCpp.pdf%22%2C%22user_params%22%3A%22%22%2C%22anchor%22%3A%22%22%2C%22href%22%3A%22https%3A%2F%2Fwww.grimm-jaud.de%2Fimages%2Fstories%2Fpdfs%2FTheManyFlavorsOfConstnessInModernCpp.pdf%22%2C%22mediasync_id%22%3A%22%22%2C%22ir_link%22%3A1%2C%22custom%22%3A%7B%7D%2C%22type%22%3A%22E%22%2C%22subject%22%3A%22%22%2C%22alias%22%3A%22%22%2C%22text%22%3A%22The%20Many%20Flavors%20of%20Constness%20in%20Modern%20C%2B%2B%22%7D" href="https://www.grimm-jaud.de/images/stories/pdfs/TheManyFlavorsOfConstnessInModernCpp.pdf">The Many Flavors of Constness in Modern C++</a> </li><li> <a title="Link auf https://www.grimm-jaud.de/images/stories/pdfs/ObjectOrientedProgramming.pdf" alt="%7B%22mediasync_id%22%3A%22%22%2C%22href%22%3A%22https%3A%2F%2Fwww.grimm-jaud.de%2Fimages%2Fstories%2Fpdfs%2FObjectOrientedProgramming.pdf%22%2C%22anchor%22%3A%22%22%2C%22user_params%22%3A%22%22%2C%22destination%22%3A%22https%3A%2F%2Fwww.grimm-jaud.de%2Fimages%2Fstories%2Fpdfs%2FObjectOrientedProgramming.pdf%22%2C%22custom%22%3A%7B%7D%2C%22ir_link%22%3A1%2C%22target%22%3A%22_blank%22%2C%22version%22%3A1%2C%22text%22%3A%22Object-Oriented%20Programming%3A%20The%20Good%20Parts%22%2C%22subject%22%3A%22%22%2C%22alias%22%3A%22%22%2C%22type%22%3A%22E%22%7D" href="https://www.grimm-jaud.de/images/stories/pdfs/ObjectOrientedProgramming.pdf">Object-Oriented Programming: The Good Parts</a> </li><li> <a title="Link auf https://www.grimm-jaud.de/images/stories/pdfs/C20TheSmallPearls.pdf" alt="%7B%22alias%22%3A%22%22%2C%22subject%22%3A%22%22%2C%22text%22%3A%22C%2B%2B20%3A%20The%20Small%20Pearls%22%2C%22type%22%3A%22E%22%2C%22ir_link%22%3A1%2C%22custom%22%3A%7B%7D%2C%22destination%22%3A%22https%3A%2F%2Fwww.grimm-jaud.de%2Fimages%2Fstories%2Fpdfs%2FC20TheSmallPearls.pdf%22%2C%22user_params%22%3A%22%22%2C%22anchor%22%3A%22%22%2C%22mediasync_id%22%3A%22%22%2C%22href%22%3A%22https%3A%2F%2Fwww.grimm-jaud.de%2Fimages%2Fstories%2Fpdfs%2FC20TheSmallPearls.pdf%22%2C%22version%22%3A1%2C%22target%22%3A%22_blank%22%7D" href="https://www.grimm-jaud.de/images/stories/pdfs/C20TheSmallPearls.pdf">C++20: The Small Pearls</a> </li></ul></div><div class="ztitel">Wie geht's weiter?</div><div class="text">In meinem nächsten Artikel setze ich meine Reise mit der Template-Metaprogrammierung fort und gebe dir weitere Einblicke.<br></div>